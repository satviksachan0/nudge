generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

//////////////////////
// ENUMS
//////////////////////

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum ReminderRuleType {
  BEFORE_DUE
  ON_DUE
  AFTER_DUE
}

enum ReminderProposalStatus {
  PENDING
  APPROVED
  CANCELLED
  SENT
}

enum ReminderChannel {
  EMAIL
  WHATSAPP
}

enum ReminderExecutionStatus {
  SENT
  FAILED
}

enum EmailOwner {
  USER
  CLIENT
}

//////////////////////
// MODELS
//////////////////////

model Account {
  id   String @id @default(uuid())
  name String

  users    User[]
  clients  Client[]
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id    String  @id @default(uuid())
  name  String
  phone String?

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  invoices          Invoice[]
  reminderRules     ReminderRule[]
  reminderProposals ReminderProposal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id          String        @id @default(uuid())
  invoiceNo   String
  amount      Decimal
  currency    String        @default("INR")
  dueDate     DateTime
  invoiceDate DateTime
  status      InvoiceStatus @default(DRAFT)
  pdfUrl      String?

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  reminderProposals ReminderProposal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([clientId])
}

model ReminderRule {
  id String @id @default(uuid())

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  type     ReminderRuleType
  config   Json
  isActive Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reminderProposals ReminderProposal[]
}

model ReminderProposal {
  id String @id @default(uuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  ruleId String
  rule   ReminderRule @relation(fields: [ruleId], references: [id])

  scheduledFor DateTime
  message      String

  status ReminderProposalStatus @default(PENDING)

  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  executions ReminderExecution[]

  @@unique([invoiceId, ruleId, scheduledFor])
}

model ReminderExecution {
  id String @id @default(uuid())

  proposalId String
  proposal   ReminderProposal @relation(fields: [proposalId], references: [id])

  channel ReminderChannel
  status  ReminderExecutionStatus

  sentAt       DateTime
  providerResp Json?

  createdAt DateTime @default(now())
}

model EmailAddress {
  id        String  @id @default(uuid())
  email     String
  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  ownerType EmailOwner
  ownerId   String

  createdAt DateTime @default(now())

  @@index([ownerId, ownerType])
}
